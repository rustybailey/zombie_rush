pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
frames = 1
screen_width = 128
half_screen_width = screen_width / 2
screen_height = 128
half_screen_height = screen_height / 2
frame_rate = 60
score = 0


function test_collision(a, b)
	return (
		a.x < b.x + b.width and
		a.x + a.width > b.x and
		a.y < b.y + b.height and
		a.y + a.height > b.y
	)
end

player = {
	x = 64,
	y = 64,
	width = 5,
	height = 8,
	dx = 0,
	dy = 0,
	ddx = 0,
	ddy = 0,
	cur_spr = 1,
	mirror = false,
	hp = 3,
	grounded = function(self)
	  local v = mget(flr(self.x+4)/8, flr(self.y)/8+1)
    return fget(v, 0)
	end,
	draw = function(self)
		spr(
			self.cur_spr,
			self.x,
			self.y,
			1,
			1,
			self.mirror
		)
	end,
	move = function(self)
    -- x acceleration
    self.ddx = 0
    if (btn(0)) self.ddx=-.25
    if (btn(1)) self.ddx=.25

    -- apply x accel
    self.dx += self.ddx

    -- limit max speed
    local max_speed = 1
    if self.dx > max_speed then
      self.dx = max_speed
    elseif self.dx < -max_speed then
      self.dx = -max_speed
    end

    -- drag
    if self.ddx == 0 then
      self.dx *= 0.8
    end

		-- y velocity
		if self:grounded() then
			if (btnp(4)) then
				self.dy=-6
				sfx(3)
			else
				self.dy = 0
				-- fix position
				-- or else he'll be sunk into floor
				self.y = flr(flr(self.y)/8)*8
			end
		else
			-- gravity accel
			self.dy += 0.98
		end

		-- update position based on vel
		self.x += self.dx
		self.y += self.dy

		if self.x + self.width + 1 >= screen_width then self.x = screen_width - self.width - 1 end
		if self.x < 0 then self.x = 0 end
	end,
	update = function(self)
	  if (btn(0) or btn(1)) then
	  	if frames%5 == 0 then
		  	if self.cur_spr == 4 then
	  			self.cur_spr = 5
		  	else
	  			self.cur_spr = 4
		  	end
		  end
		else
			self.cur_spr = 1
	  end

		if btn(0) then
			self.mirror = true;
		end

		if btn(1) then
			self.mirror = false;
		end

		self:move()
	end
}

sword = {
	x = player.x,
	y = player.y,
	width = 6,
	height = 3,
	sprite = 6,
	mirror = false,
	update = function(self)
		if btn(5) then
			self.visible = true
			self.x = player.x + 6
			self.y = player.y
			self.mirror = player.mirror
			if self.mirror then
				self.x = player.x - 6
			end
		else
			self.visible = false
		end
	end,
	draw = function(self)
	 	if self.visible then
			spr(
				self.sprite,
				self.x,
				self.y,
				1,
				1,
				self.mirror
			)
		end
	end
}

baddies = {}

function make_baddie(x, speed)
	return {
		x = x,
		y = screen_height - 16,
		width = 3,
		height = 8,
		sprite = 32,
		mirror = x < 0,
		speed = speed,
		update = function(self)
			if (sword.visible) then
				if test_collision(self, sword) then
					sfx(2)
					del(baddies, self)
					score+=1
				end
			end

			if test_collision(self, player) then
				player.hp -= 1
				del(baddies, self)
				sfx(1)
			end

			if (self.mirror) then
				self.x+=self.speed
			else
				self.x-=self.speed
			end
		end,
		draw = function(self)
			spr(
				self.sprite,
				self.x,
				self.y,
				1,
				1,
				self.mirror
			)
		end
	}
end

function update_frames()
  frames+=1
  if frames > frame_rate then frames = 1 end
end

function add_baddie()
	local direction = flr(rnd(2)) + 1
	local x = -10
	if direction == 1 then
		x = screen_width + 10
	end
	add(baddies, make_baddie(x, flr(rnd(1.2)) + .5))
end

function _update60()
 	update_frames()

 	if (player.hp == 0) then
 		return
 	end

	player:update()
	sword:update()

	if frames % 30 == 0 then
		add_baddie()
	end

	for k, baddie in pairs(baddies) do
		baddie:update()
	end
end

function _draw()
 	cls()
 	-- draw the map
 	map(0,0, 0,0, 16,16)

 	if (player.hp == 0) then
 		print("game over", 64-(4*4.5), 64, 10)
 	else
		player:draw()
		sword:draw()
		for k, baddie in pairs(baddies) do
			baddie:draw()
		end
	end

	print("score: ", 0, 0, 10)
	print(score, 28, 0, 10)

	print("hp: ", screen_width-16, 0, 10)
	print(player.hp, screen_width-4, 0, 10)
end
__gfx__
0000000000fff00000fff0000000000000fff00000fff00000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000fcfc0000fcfc000000000000fcfc0000fcfc0000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070000fff00000fff0000000000000fff00000fff0000a000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000999900009999900000000000999900009999000adaaaa00000000000000000000000000000000000000000000000000000000000000000000000000
0007700009999000099990000000000009999000099990000a000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000cccc0000cccc000000000000cccc0000cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000c00c0000c00c000000000000000c0000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000050050000500500000000000000050000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddddddd7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddddd71000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd777711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd777711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd777711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd777711000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d7111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
71111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000d7700bbbbbbbb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077d009bbbbb9b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077700999b99990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccc00999b99990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000ccc00999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000aaa00999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000a0a00999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000a0a00999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121212121212121212121212121212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000200001705014050100500b0500a050080500805007050050500405002050100500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000013750107500b7500575000750007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700
0004000021050240502d0503000000000000000000014000170001d00027000350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000300001e7502675033750337503375033750337002a7000070023700237001e7002670033700337003370033700337000070000700007000070000700007000070000700007000070000700007000070000700
