pico-8 cartridge // http://www.pico-8.com
version 27
__lua__
frames = 1
screen_width = 128
half_screen_width = screen_width / 2
screen_height = 128
half_screen_height = screen_height / 2
frame_rate = 60
score = 0


function test_collision(a, b)
	return (
		a.x < b.x + b.width and
		a.x + a.width > b.x and
		a.y < b.y + b.height and
		a.y + a.height > b.y
	)
end

player = {
	x = 64,
	y = 64,
	width = 5,
	height = 8,
	dx = 0,
	dy = 0,
	ddx = 0,
	ddy = 0,
	cur_spr = 1,
	mirror = false,
	hp = 3,
	grounded = function(self)
	  local v = mget(flr(self.x+4)/8, flr(self.y)/8+1)
    return fget(v, 0)
	end,
	draw = function(self)
		spr(
			self.cur_spr,
			self.x,
			self.y,
			1,
			1,
			self.mirror
		)
	end,
	move = function(self)
    -- x acceleration
    self.ddx = 0
    if (btn(0)) self.ddx=-.25
    if (btn(1)) self.ddx=.25

    -- apply x accel
    self.dx += self.ddx

    -- limit max speed
    local max_speed = 1
    if self.dx > max_speed then
      self.dx = max_speed
    elseif self.dx < -max_speed then
      self.dx = -max_speed
    end

    -- drag
    if self.ddx == 0 then
      self.dx *= 0.8
    end

		-- y velocity
		if self:grounded() then
			if (btnp(4)) then
				self.dy=-6
				sfx(3)
			else
				self.dy = 0
				-- fix position
				-- or else he'll be sunk into floor
				self.y = flr(flr(self.y)/8)*8
			end
		else
			-- gravity accel
			self.dy += 0.98
		end

		-- update position based on vel
		self.x += self.dx
		self.y += self.dy

		if self.x + self.width + 1 >= screen_width then self.x = screen_width - self.width - 1 end
		if self.x < 0 then self.x = 0 end
	end,
	update = function(self)
	  if (btn(0) or btn(1)) then
	  	if frames%5 == 0 then
		  	if self.cur_spr == 4 then
	  			self.cur_spr = 5
		  	else
	  			self.cur_spr = 4
		  	end
		  end
		else
			self.cur_spr = 1
	  end

		if btn(0) then
			self.mirror = true;
		end

		if btn(1) then
			self.mirror = false;
		end

		self:move()
	end
}

sword = {
	x = player.x,
	y = player.y,
	width = 6,
	height = 3,
	sprite = 6,
	mirror = false,
	update = function(self)
		if btn(5) then
			self.visible = true
			self.x = player.x + 6
			self.y = player.y
			self.mirror = player.mirror
			if self.mirror then
				self.x = player.x - 6
			end
		else
			self.visible = false
		end
	end,
	draw = function(self)
	 	if self.visible then
			spr(
				self.sprite,
				self.x,
				self.y,
				1,
				1,
				self.mirror
			)
		end
	end
}

baddies = {}

function make_baddie(x, speed)
	return {
		x = x,
		y = screen_height - 16,
		width = 3,
		height = 8,
		sprite = 32,
		mirror = x < 0,
		speed = speed,
		update = function(self)
			if (sword.visible) then
				if test_collision(self, sword) then
					sfx(2)
					del(baddies, self)
					score+=1
				end
			end

			if test_collision(self, player) then
				player.hp -= 1
				del(baddies, self)
				sfx(1)
			end

			if (self.mirror) then
				self.x+=self.speed
			else
				self.x-=self.speed
			end
		end,
		draw = function(self)
			spr(
				self.sprite,
				self.x,
				self.y,
				1,
				1,
				self.mirror
			)
		end
	}
end

function update_frames()
  frames+=1
  if frames > frame_rate then frames = 1 end
end

function add_baddie()
	local direction = flr(rnd(2)) + 1
	local x = -10
	if direction == 1 then
		x = screen_width + 10
	end
	add(baddies, make_baddie(x, flr(rnd(1.2)) + .5))
end

function _update60()
 	update_frames()

 	if (player.hp == 0) then
 		return
 	end

	player:update()
	sword:update()

	if frames % 30 == 0 then
		add_baddie()
	end

	for k, baddie in pairs(baddies) do
		baddie:update()
	end
end

function _draw()
 	cls()
 	-- draw the map
 	map(0,0, 0,0, 16,16)

 	if (player.hp == 0) then
 		print("game over", 64-(4*4.5), 64, 10)
 	else
		player:draw()
		sword:draw()
		for k, baddie in pairs(baddies) do
			baddie:draw()
		end
	end

	print("score: ", 0, 0, 10)
	print(score, 28, 0, 10)

	print("hp: ", screen_width-16, 0, 10)
	print(player.hp, screen_width-4, 0, 10)
end
__gfx__
0000000000fff00000fff0000000000000fff00000fff000000000000000000bbbb0000bbbbb000bbb0000000000000000000000000000000000000000000000
0000000000fcfc0000fcfc000000000000fcfc0000fcfc0000000000000000bbcccbbbbcccccb0bcccb000000000000006666666666600000000000000000000
0070070000fff00000fff0000000000000fff00000fff0000a0000000000bbbcccccbbcccccccbccccbb00000000000666666666666666000000000000000000
000770000999900009999900000000000999900009999000adaaaa00000bbcbccccccccccccccccccccb00000000006666666666666666600000000000000000
0007700009999000099990000000000009999000099990000a00000000bbcc88cccccccccccccc88cccb000000000666666666666666aa660000000000000000
007007000cccc0000cccc000000000000cccc0000cccc0000000000000bccc88cccccccccccccc88cccb000000006666666666666666aa666000000000000000
000000000c00c0000c00c000000000000000c0000c0000000000000000bcccccccccccccccccccccccbb000000066666aaaa6666666666666600000000000000
0000000005005000050050000000000000005000050000000000000000bccbbcccccc88cccccccccccbbb00000066666aaaa6666666666666600000000000000
ddddddd700000000000000000000000000000000000000000000000000bbbbbcccccc88cccccccccccccbb000066666666666666666666666660000000000000
dddddd71000000000000000000000000000000000000000000000000000000bccccccccccccccccccccccb000066666666666666666666666660000000000000
dd777711000000000000000000000000000000000000000000000000000000bbcccccccccccccccccc88cb000066666666666666666666666660000000000000
dd7777110000000000000000000000000000000000000000000000000000000bcccccccccccccccccc88cb000066666666666666666666666660000000000000
dd7777110000000000000000000000000000000000000000000000000000000bb88bbccccccbbbbcccccbb00006aa66666666666666666666660000000000000
dd7777110000000000000000000000000000000000000000000000000000000008800bbcbbbbb0bbbbbbb000006aa66666666666666666666660000000000000
d71111110000000000000000000000000000000000000000000000000000000000000bbbbbbbb00000000000006666666666666666666aa66660000000000000
711111110000000000000000000000000000000000000000000000000000000000000bbbbbbbb0000000000000666666666666666666aaa66660000000000000
000d7700bbbbbbbb00000000000000000000000000000000000000000000000000000bbbbbbbb0000000000000666666666666666666aaa66660000000000000
00077d009bbbbb9b0000000000000000000000000000000000000000000000000000bbbbbbbbb0000000000000666666666666666666aa666660000000000000
00077700999b99990000000000000000000000000000000000000000000000000000bbbbbbbbb000000000000066666666666666666666666660000000000000
cccccc00999b99990000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000666666aaa6666666666666600000000000000
000ccc00999999990000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000666666aaaa666666666666600000000000000
000aaa00999999990000000000000000000000000000000000000000000000000000bbbbbbbbb000000000000000666666aaa666666666666000000000000000
000a0a0099999999000000000000000000000000000000000000000000000000000bbbbbbbbbbb00000000000000066666666666666666660000000000000000
000a0a0099999999000000000000000000000000000000000000000000000000000bbbbbbbbbbb00000000000000006666666666666666600000000000000000
0000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbb00000000000000000666666666666666000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbb000000000000000006666666666600000000000000000000
000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbb00000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbb0000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbb00000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000aaa0000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000aaa0000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000aaa0000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000aaaaa000000000000000000000000000000000000000000000000000000
00000000000000007777700000000000000000000000000000000000000000000000aaaaaaa00000000000000000000000000000000000000000000000000000
00000000000000077777777000000000000000000007770000000000000000000aaaaaaaaaaaaaa0000000000000000000000000000000000000000000000000
000000000000000777777777777770000000000000777777000000000000000000aaaaaaaaaaaa00000000000000000000000000000000000000000000000000
00000000777770777777777777777700000000000777777770000000000000000000aaaaaaaa0000000000000000000000000000000000000000000000000000
000000777777777777777777777777000000777777777777770000000000000000000aaaaaa00000000000000000000000000000000000000000000000000000
00000777777777777777777777777770000777777777777777700000000000000000aaaaaaaa0000000000000000000000000000000000000000000000000000
00007777777777777777777777777770000777777777777777770777700000000000aaa00aaa0000000000000000000000000000000000000000000000000000
0000777777777777777777777777777000077777777777777777777777000000000aaa0000aaa000000000000000000000000000000000000000000000000000
0077777777777777777777777777777000077777777777777777777777700000000aa000000aa000000000000000000000000000000000000000000000000000
00777777777777777777777777777777000777777777777777777777777700000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777777777777777000777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777777777777777000777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777777777777777000777777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777777777777777000077777777777777777777777770000000000000000000000000000000000000000000000000000000000000000000
00777777777777777777777777777777000077777777777777777777777777000000000000000000000000000000000000000000000000000000000000000000
00007777777777777770777777777777000000077777777777777777777777700000000000000000000000000000000000000000000000000000000000000000
00000007777777777000077777777700000000077777777777777777777777700000000000000000000000000000000000000000000000000000000000000000
00000000077777700000007777777000000000077777777777777777777777700000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000007777777700777777777777700000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000077777777777700000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000007777777770000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000777777700000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000007777000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000004849000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000005859000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4445464748490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5455565758590000000b0c0d0e00004243000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6465666700404142431b1c1d1e50515253000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7475767700505152532b2c2d2e60616263000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0048490000606162633b3c3d3e70484973000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0058590048497172730000484900585900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000058590000000000585900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000708090a000000000708090a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001718191a000000001718191a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002728292a000000002728292a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
003738393a000000003738393a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2121212121212121212121212121212100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000200001705014050100500b0500a050080500805007050050500405002050100500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000013750107500b7500575000750007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700007000070000700
0004000021050240502d0503000000000000000000014000170001d00027000350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000300001e7502675033750337503375033750337002a7000070023700237001e7002670033700337003370033700337000070000700007000070000700007000070000700007000070000700007000070000700
011000080f553000001f6550f5000f5531f6550f5531f655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
